<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>瑞士行 - Travel Map</title>
  <style>
    /* 基本樣式 */
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: calc(100% - 250px); float: right; }
    #sidebar { width: 250px; height: 100%; float: left; overflow: auto; padding: 10px; background: #f8f8f8; }
    .control { margin-bottom: 10px; }
    #drawing-tools { position: absolute; top: 10px; right: 10px; background: white; padding: 5px; border: 1px solid #ccc; z-index: 5; }
    #search-box { width: 90%; padding: 5px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <!-- 左側欄位 -->
  <div id="sidebar">
    <h2>瑞士行 - 圖層控制</h2>
    <div class="control">
      <input type="file" id="file-input" multiple />
      <p>支援格式: KML, CSV, JSON</p>
    </div>
    <div class="control">
      <label for="poi-density">商家/地標顯示密度:</label>
      <input type="range" id="poi-density" min="0" max="100" value="50">
    </div>
    <div class="control">
      <h3>圖層列表</h3>
      <ul id="layer-list">
        <!-- 動態新增圖層名稱 -->
      </ul>
    </div>
  </div>
  
  <!-- 地圖容器 -->
  <div id="map"></div>
  
  <!-- 右上角繪圖工具 -->
  <div id="drawing-tools">
    <button id="toggle-drawing">啟用繪圖</button>
    <button id="save-drawing">儲存圖層</button>
  </div>
  
  <!-- 載入 Google Maps API (記得將 YOUR_API_KEY 換成真實金鑰) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDdn8mykqlHT8WPT_tnrZmj5OS4JYw0UPM&libraries=drawing,places"></script>
  <script>
    let map;
    let drawingManager;
    let layers = [];
    let currentLayerMarkers = [];
    let poiMarkers = [];
    let currentDrawing = null;

    function initMap() {
      // 設定瑞士中央座標
      const swissCenter = { lat: 46.8182, lng: 8.2275 };
      map = new google.maps.Map(document.getElementById('map'), {
        center: swissCenter,
        zoom: 8,
        mapTypeId: 'roadmap'
      });
      
      // 顯示「瑞士行」標題 (以自訂控制項方式呈現)
      const titleDiv = document.createElement('div');
      titleDiv.style.backgroundColor = '#fff';
      titleDiv.style.border = '1px solid #000';
      titleDiv.style.padding = '5px';
      titleDiv.style.margin = '10px';
      titleDiv.innerHTML = '<strong>瑞士行</strong>';
      map.controls[google.maps.ControlPosition.TOP_CENTER].push(titleDiv);

      // 點擊地圖新增標記
      map.addListener('click', function(e) {
        addMarkerToCurrentLayer(e.latLng);
      });

      // 初始化繪圖工具
      initDrawingManager();

      // 檔案匯入監聽
      document.getElementById('file-input').addEventListener('change', handleFileSelect, false);

      // 調整 POI 密度 (此處僅模擬效果，實際可連接 Places API)
      document.getElementById('poi-density').addEventListener('input', function(e) {
        adjustPOIDensity(e.target.value);
      });

      // 切換繪圖模式
      document.getElementById('toggle-drawing').addEventListener('click', toggleDrawingMode);
      document.getElementById('save-drawing').addEventListener('click', saveDrawing);
      
      // 初始化搜尋框（旅遊地圖常見功能：快速搜尋景點或地址）
      initSearchBox();
    }

    function initDrawingManager() {
      drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: false,
        markerOptions: { draggable: true },
        polylineOptions: { editable: true },
        polygonOptions: { editable: true },
        rectangleOptions: { editable: true },
        circleOptions: { editable: true }
      });
      drawingManager.setMap(map);

      // 完成繪製後的事件處理
      google.maps.event.addListener(drawingManager, 'overlaycomplete', function(e) {
        currentDrawing = e.overlay;
        // 將繪製結果加入圖層列表
        addLayer('自定義繪圖');
      });
    }

    function toggleDrawingMode() {
      if (drawingManager.getDrawingMode()) {
        drawingManager.setDrawingMode(null);
        document.getElementById('toggle-drawing').innerText = '啟用繪圖';
      } else {
        // 這裡預設繪製標記，可依需求改為多邊形等模式
        drawingManager.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
        document.getElementById('toggle-drawing').innerText = '停用繪圖';
      }
    }

    function saveDrawing() {
      if (currentDrawing) {
        // 將繪製資料轉為儲存格式並送往後端 (後端需串接 Google Cloud datasets)
        const data = getOverlayData(currentDrawing);
        saveDataToCloud(data);
      } else {
        alert('目前沒有繪製的圖形');
      }
    }

    function getOverlayData(overlay) {
      // 將 overlay 轉為可儲存資料格式
      if (overlay.getPath) { // 多邊形或折線
        const path = overlay.getPath().getArray().map(latlng => ({ lat: latlng.lat(), lng: latlng.lng() }));
        return { type: 'poly', path: path };
      } else if (overlay.getPosition) { // 標記
        const pos = overlay.getPosition();
        return { type: 'marker', position: { lat: pos.lat(), lng: pos.lng() } };
      }
      return {};
    }

    function saveDataToCloud(data) {
      // 此函數模擬將資料送往後端，後端再與 Google Cloud 的 datasets 做串接
      console.log('Saving to Google Cloud:', data);
      fetch('/saveData', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        console.log('Data saved:', result);
      })
      .catch(err => {
        console.error('Error saving data:', err);
      });
    }

    function addMarkerToCurrentLayer(location) {
      const marker = new google.maps.Marker({
        position: location,
        map: map,
        draggable: true
      });
      currentLayerMarkers.push(marker);
      addLayer('新增點');
    }

    function handleFileSelect(evt) {
      const files = evt.target.files;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        reader.onload = function(e) {
          const content = e.target.result;
          if (file.name.endsWith('.kml')) {
            // KML 匯入：利用 KmlLayer（注意：Blob URL 可能受瀏覽器安全性限制）
            const kmlLayer = new google.maps.KmlLayer({
              url: URL.createObjectURL(new Blob([content], {type: 'application/vnd.google-earth.kml+xml'})),
              map: map
            });
            layers.push(kmlLayer);
            addLayer(file.name);
          } else if (file.name.endsWith('.json')) {
            const jsonData = JSON.parse(content);
            // 假設 JSON 為點資料陣列，欄位含 lat, lng, name
            jsonData.forEach(item => {
              const marker = new google.maps.Marker({
                position: { lat: item.lat, lng: item.lng },
                map: map,
                title: item.name || ''
              });
              currentLayerMarkers.push(marker);
            });
            addLayer(file.name);
          } else if (file.name.endsWith('.csv')) {
            // 簡易 CSV 解析，假設格式：lat,lng,name
            const lines = content.split('\n');
            lines.forEach(line => {
              const parts = line.split(',');
              if (parts.length >= 2) {
                const lat = parseFloat(parts[0]);
                const lng = parseFloat(parts[1]);
                const title = parts[2] || '';
                if (!isNaN(lat) && !isNaN(lng)) {
                  const marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    title: title
                  });
                  currentLayerMarkers.push(marker);
                }
              }
            });
            addLayer(file.name);
          }
          // 匯入後順便將資料存入 Google Cloud（透過後端處理）
          saveDataToCloud({ importedFile: file.name, content: content });
        };
        reader.readAsText(file);
      }
    }

    function addLayer(name) {
      const li = document.createElement('li');
      li.textContent = name;
      document.getElementById('layer-list').appendChild(li);
    }

    function adjustPOIDensity(value) {
      // 模擬依據 slider 調整地標密度，實際應用可根據 Places API 更新資料
      console.log('調整 POI 密度為:', value);
      poiMarkers.forEach(marker => marker.setMap(null));
      poiMarkers = [];
      const numMarkers = Math.floor(value);
      for (let i = 0; i < numMarkers; i++) {
        const marker = new google.maps.Marker({
          position: {
            lat: 46.8182 + (Math.random() - 0.5),
            lng: 8.2275 + (Math.random() - 0.5)
          },
          map: map,
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
          }
        });
        poiMarkers.push(marker);
      }
    }

    function initSearchBox() {
      // 加入搜尋框，方便查詢地點（使用 Places Autocomplete）
      const input = document.createElement('input');
      input.id = 'search-box';
      input.type = 'text';
      input.placeholder = '搜尋地點...';
      map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
      const autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.bindTo('bounds', map);
      autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          alert("找不到此地點");
          return;
        }
        map.setCenter(place.geometry.location);
        map.setZoom(12);
      });
    }

    // 初始化地圖
    window.onload = initMap;
  </script>
</body>
</html>
