<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç‘å£«è¡Œ - äº’å‹•å¼æ—…éŠåœ°åœ–</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    #header {
      background-color: #2c3e50;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    #main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    #sidebar {
      width: 300px;
      background-color: #f5f5f5;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      z-index: 2;
    }
    
    #map-container {
      flex: 1;
      position: relative;
    }
    
    #map {
      height: 100%;
      width: 100%;
    }
    
    .layer-item {
      margin-bottom: 10px;
      padding: 10px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .layer-item h3 {
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
    }
    
    .import-section {
      margin: 20px 0;
      padding: 15px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .button:hover {
      background-color: #2980b9;
    }
    
    .toggle-visibility {
      cursor: pointer;
      color: #7f8c8d;
    }
    
    .toggle-visibility:hover {
      color: #2c3e50;
    }
    
    #drawing-tools {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      padding: 8px;
      z-index: 1;
    }
    
    #drawing-tools button {
      display: block;
      width: 100%;
      margin-bottom: 5px;
      background-color: #f8f9fa;
      border: 1px solid #dadce0;
      padding: 8px 12px;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }
    
    #drawing-tools button:hover {
      background-color: #e8eaed;
    }
    
    #drawing-tools button.active {
      background-color: #e0f0fd;
      border-color: #3498db;
    }
    
    #poi-density-control {
      position: absolute;
      bottom: 20px;
      left: 320px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      padding: 10px;
      z-index: 1;
    }
    
    #weather-widget {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      padding: 10px;
      z-index: 1;
      min-width: 200px;
    }
    
    .hidden {
      display: none;
    }
    
    .tooltip {
      position: absolute;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      padding: 10px;
      z-index: 10;
      max-width: 300px;
    }
    
    input[type="file"] {
      margin: 10px 0;
    }
    
    input[type="range"] {
      width: 100%;
    }
    
    .travel-tips {
      margin-top: 20px;
      padding: 15px;
      background-color: #e8f4fc;
      border-radius: 5px;
    }
    
    #search-box {
      margin-bottom: 15px;
      position: relative;
    }
    
    #search-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    #itinerary-section {
      margin-top: 20px;
    }
    
    .itinerary-day {
      margin-bottom: 15px;
      padding: 10px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .transport-icons {
      margin-top: 5px;
      display: flex;
      gap: 5px;
    }
    
    .transport-icons img {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>ç‘å£«è¡Œ</h1>
    <div>
      <button id="save-button" class="button">å„²å­˜è³‡æ–™</button>
      <button id="share-button" class="button">åˆ†äº«åœ°åœ–</button>
    </div>
  </div>
  
  <div id="main-container">
    <div id="sidebar">
      <div id="search-box">
        <input type="text" id="search-input" placeholder="æœå°‹åœ°é»...">
      </div>
      
      <div class="import-section">
        <h2>åŒ¯å…¥è³‡æ–™</h2>
        <input type="file" id="file-upload" accept=".kml,.csv,.json,.geojson">
        <button id="import-button" class="button">åŒ¯å…¥</button>
        <div>
          <small>æ”¯æ´æ ¼å¼: KML, CSV, JSON</small>
        </div>
      </div>
      
      <div id="layers-section">
        <h2>åœ–å±¤</h2>
        <button id="add-layer-button" class="button">æ–°å¢åœ–å±¤</button>
        
        <div id="layers-container">
          <!-- åœ–å±¤æœƒå‹•æ…‹æ·»åŠ åœ¨é€™è£¡ -->
          <div class="layer-item">
            <h3>
              æ™¯é»åœ–å±¤
              <span class="toggle-visibility">ğŸ‘ï¸</span>
            </h3>
            <div class="layer-content">
              <small>åŒ…å« 5 å€‹åœ°é»</small>
            </div>
          </div>
          
          <div class="layer-item">
            <h3>
              é¤å»³åœ–å±¤
              <span class="toggle-visibility">ğŸ‘ï¸</span>
            </h3>
            <div class="layer-content">
              <small>åŒ…å« 3 å€‹åœ°é»</small>
            </div>
          </div>
        </div>
      </div>
      
      <div id="itinerary-section">
        <h2>è¡Œç¨‹è¦åŠƒ</h2>
        <button id="add-day-button" class="button">æ–°å¢å¤©æ•¸</button>
        
        <div class="itinerary-day">
          <h3>ç¬¬ 1 å¤©</h3>
          <div>è˜‡é»ä¸– â†’ ç‰æ£®</div>
          <div class="transport-icons">
            <span title="ç«è»Š">ğŸš‚</span>
            <span title="æ­¥è¡Œ">ğŸš¶</span>
          </div>
        </div>
      </div>
      
      <div class="travel-tips">
        <h3>æ—…éŠå°è²¼å£«</h3>
        <p>ç‘å£«çš„å…¬å…±äº¤é€šéå¸¸ç™¼é”ï¼Œå»ºè­°è³¼è²·ç‘å£«æ—…è¡Œé€šè¡Œè­‰å¯ä»¥ç¯€çœè²»ç”¨ã€‚</p>
        <button id="more-tips-button" class="button">æ›´å¤šè²¼å£«</button>
      </div>
    </div>
    
    <div id="map-container">
      <div id="map"></div>
      
      <div id="drawing-tools">
        <button id="marker-tool" class="active">ğŸ“ æ¨™è¨˜é»</button>
        <button id="line-tool">ã€°ï¸ è·¯ç·š</button>
        <button id="polygon-tool">â¬› å€åŸŸ</button>
        <button id="circle-tool">â­• åœ“å½¢</button>
        <button id="hand-tool">âœ‹ ç§»å‹•</button>
        <button id="delete-tool">ğŸ—‘ï¸ åˆªé™¤</button>
      </div>
      
      <div id="poi-density-control">
        <label for="poi-density">æ™¯é»/å•†å®¶é¡¯ç¤ºå¯†åº¦:</label>
        <input type="range" id="poi-density" min="0" max="100" value="50">
      </div>
      
      <div id="weather-widget">
        <h3>è˜‡é»ä¸–å¤©æ°£</h3>
        <div>â˜€ï¸ 22Â°C</div>
        <small>æœªä¾†ä¸€é€±æº«åº¦: 18Â°C - 25Â°C</small>
      </div>
    </div>
  </div>
  
  <script>
    // å…¨å±€è®Šé‡
    let map;
    let drawingManager;
    let layers = [];
    let activeMarkerId = null;
    let markers = [];
    let polylines = [];
    let polygons = [];
    let activeDrawingTool = 'marker';
    
    // åˆå§‹åŒ–åœ°åœ–
    function initMap() {
      // ç‘å£«ä¸­å¿ƒé»åæ¨™ (å¤§ç´„åœ¨ Bern é™„è¿‘)
      const switzerlandCenter = { lat: 46.8182, lng: 8.2275 };
      
      // å‰µå»ºåœ°åœ–
      map = new google.maps.Map(document.getElementById('map'), {
        center: switzerlandCenter,
        zoom: 8,
        mapTypeId: google.maps.MapTypeId.TERRAIN,
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
          position: google.maps.ControlPosition.TOP_LEFT
        }
      });
      
      // åˆå§‹åŒ–ç¹ªåœ–ç®¡ç†å™¨
      drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: false,
        markerOptions: {
          draggable: true
        },
        polylineOptions: {
          strokeColor: '#FF0000',
          strokeWeight: 3
        },
        polygonOptions: {
          strokeColor: '#FF0000',
          strokeWeight: 2,
          fillColor: '#FF0000',
          fillOpacity: 0.3
        },
        circleOptions: {
          strokeColor: '#FF0000',
          strokeWeight: 2,
          fillColor: '#FF0000',
          fillOpacity: 0.3
        }
      });
      
      drawingManager.setMap(map);
      
      // æ·»åŠ äº‹ä»¶ç›£è½å™¨
      setupEventListeners();
      
      // æ·»åŠ ä¸€äº›é è¨­æ¨™è¨˜ä½œç‚ºç¤ºä¾‹
      addDefaultMarkers();
      
      // åˆå§‹åŒ–åœ°é»æœå°‹
      initPlacesAutocomplete();
    }
    
    function setupEventListeners() {
      // ç¹ªåœ–å·¥å…·æŒ‰éˆ•äº‹ä»¶
      document.getElementById('marker-tool').addEventListener('click', () => activateDrawingTool('marker'));
      document.getElementById('line-tool').addEventListener('click', () => activateDrawingTool('polyline'));
      document.getElementById('polygon-tool').addEventListener('click', () => activateDrawingTool('polygon'));
      document.getElementById('circle-tool').addEventListener('click', () => activateDrawingTool('circle'));
      document.getElementById('hand-tool').addEventListener('click', () => activateDrawingTool('hand'));
      document.getElementById('delete-tool').addEventListener('click', () => activateDrawingTool('delete'));
      
      // åŒ¯å…¥æŒ‰éˆ•äº‹ä»¶
      document.getElementById('import-button').addEventListener('click', importData);
      
      // æ·»åŠ åœ–å±¤æŒ‰éˆ•
      document.getElementById('add-layer-button').addEventListener('click', addNewLayer);
      
      // POI å¯†åº¦æ»‘å¡Šäº‹ä»¶
      document.getElementById('poi-density').addEventListener('input', updatePoiDensity);
      
      // å„²å­˜æŒ‰éˆ•äº‹ä»¶
      document.getElementById('save-button').addEventListener('click', saveToCloud);
      
      // åˆ†äº«æŒ‰éˆ•äº‹ä»¶
      document.getElementById('share-button').addEventListener('click', shareMap);
      
      // è¡Œç¨‹æŒ‰éˆ•äº‹ä»¶
      document.getElementById('add-day-button').addEventListener('click', addItineraryDay);
      
      // æ›´å¤šè²¼å£«æŒ‰éˆ•
      document.getElementById('more-tips-button').addEventListener('click', showMoreTips);
      
      // åœ–å±¤å¯è¦‹æ€§åˆ‡æ›
      document.querySelectorAll('.toggle-visibility').forEach(toggle => {
        toggle.addEventListener('click', toggleLayerVisibility);
      });
      
      // ç¹ªåœ–å®Œæˆäº‹ä»¶
      google.maps.event.addListener(drawingManager, 'markercomplete', function(marker) {
        addMarkerToActiveLayer(marker);
      });
      
      google.maps.event.addListener(drawingManager, 'polylinecomplete', function(polyline) {
        polylines.push(polyline);
      });
      
      google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
        polygons.push(polygon);
      });
      
      google.maps.event.addListener(drawingManager, 'circlecomplete', function(circle) {
        polygons.push(circle); // ç‚ºäº†ç°¡å–®ç®¡ç†ï¼Œåœ“å½¢ä¹Ÿæ”¾å…¥ polygons é™£åˆ—
      });
      
      // åœ°åœ–é»æ“Šäº‹ä»¶ï¼Œç•¶æ‰‹å‹•æ·»åŠ æ¨™è¨˜æ™‚ä½¿ç”¨
      google.maps.event.addListener(map, 'click', function(event) {
        if (activeDrawingTool === 'marker') {
          const marker = new google.maps.Marker({
            position: event.latLng,
            map: map,
            draggable: true
          });
          
          addMarkerToActiveLayer(marker);
        }
      });
    }
    
    function activateDrawingTool(toolType) {
      // ç§»é™¤æ‰€æœ‰å·¥å…·çš„ active é¡
      document.querySelectorAll('#drawing-tools button').forEach(button => {
        button.classList.remove('active');
      });
      
      activeDrawingTool = toolType;
      
      // è¨­ç½®ç›¸æ‡‰çš„ç¹ªåœ–æ¨¡å¼
      switch (toolType) {
        case 'marker':
          document.getElementById('marker-tool').classList.add('active');
          drawingManager.setDrawingMode(null); // æˆ‘å€‘ä½¿ç”¨åœ°åœ–é»æ“Šäº‹ä»¶ä¾†è™•ç†æ¨™è¨˜
          break;
        case 'polyline':
          document.getElementById('line-tool').classList.add('active');
          drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYLINE);
          break;
        case 'polygon':
          document.getElementById('polygon-tool').classList.add('active');
          drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
          break;
        case 'circle':
          document.getElementById('circle-tool').classList.add('active');
          drawingManager.setDrawingMode(google.maps.drawing.OverlayType.CIRCLE);
          break;
        case 'hand':
          document.getElementById('hand-tool').classList.add('active');
          drawingManager.setDrawingMode(null);
          break;
        case 'delete':
          document.getElementById('delete-tool').classList.add('active');
          drawingManager.setDrawingMode(null);
          // åœ¨åˆªé™¤æ¨¡å¼ä¸‹ï¼Œæˆ‘å€‘æœƒè®“ç”¨æˆ¶é»æ“Šè¦åˆªé™¤çš„å…ƒç´ 
          break;
      }
    }
    
    function addMarkerToActiveLayer(marker) {
      markers.push(marker);
      
      // å‰µå»ºæ¨™è¨˜çš„ä¿¡æ¯çª—å£
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div>
            <h3>æ–°åœ°é»</h3>
            <p>ç·¯åº¦: ${marker.getPosition().lat().toFixed(6)}</p>
            <p>ç¶“åº¦: ${marker.getPosition().lng().toFixed(6)}</p>
            <button id="edit-marker">ç·¨è¼¯</button>
          </div>
        `
      });
      
      // æ·»åŠ æ¨™è¨˜é»æ“Šäº‹ä»¶
      marker.addListener('click', function() {
        if (activeDrawingTool === 'delete') {
          // åˆªé™¤æ¨¡å¼ä¸‹ï¼Œé»æ“Šæ¨™è¨˜å°‡å…¶åˆªé™¤
          marker.setMap(null);
          markers = markers.filter(m => m !== marker);
        } else {
          // æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œé¡¯ç¤ºæ¨™è¨˜çš„ä¿¡æ¯çª—å£
          infoWindow.open(map, marker);
        }
      });
      
      // æ›´æ–°åœ–å±¤ä¿¡æ¯
      updateLayersUI();
    }
    
    function addDefaultMarkers() {
      // æ·»åŠ ä¸€äº›ç‘å£«çš„ä¸»è¦åŸå¸‚ä½œç‚ºç¤ºä¾‹
      const cities = [
        { name: 'è˜‡é»ä¸–', lat: 47.3769, lng: 8.5417, info: 'ç‘å£«æœ€å¤§çš„åŸå¸‚ï¼Œé‡‘èä¸­å¿ƒ' },
        { name: 'æ—¥å…§ç“¦', lat: 46.2044, lng: 6.1432, info: 'åœ‹éš›çµ„ç¹”æ‰€åœ¨åœ°ï¼Œæ¹–æ¿±åŸå¸‚' },
        { name: 'ä¼¯æ©', lat: 46.9480, lng: 7.4474, info: 'ç‘å£«é¦–éƒ½ï¼Œæ­·å²è€åŸå€' },
        { name: 'ç‰æ£®', lat: 47.0502, lng: 8.3093, info: 'æ¹–å…‰å±±è‰²ï¼Œæ­·å²æ‚ ä¹…çš„åŸå¸‚' },
        { name: 'ç­–é¦¬ç‰¹', lat: 46.0207, lng: 7.7491, info: 'è‘—åæ»‘é›ªå‹åœ°ï¼Œå¯æ¬£è³é¦¬ç‰¹æ´ªå³°' }
      ];
      
      cities.forEach(city => {
        const marker = new google.maps.Marker({
          position: { lat: city.lat, lng: city.lng },
          map: map,
          title: city.name,
          animation: google.maps.Animation.DROP
        });
        
        markers.push(marker);
        
        // å‰µå»ºæ¨™è¨˜çš„ä¿¡æ¯çª—å£
        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div>
              <h3>${city.name}</h3>
              <p>${city.info}</p>
              <button id="add-to-itinerary">åŠ å…¥è¡Œç¨‹</button>
            </div>
          `
        });
        
        // æ·»åŠ æ¨™è¨˜é»æ“Šäº‹ä»¶
        marker.addListener('click', function() {
          if (activeDrawingTool === 'delete') {
            // åˆªé™¤æ¨¡å¼ä¸‹ï¼Œé»æ“Šæ¨™è¨˜å°‡å…¶åˆªé™¤
            marker.setMap(null);
            markers = markers.filter(m => m !== marker);
          } else {
            // æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œé¡¯ç¤ºæ¨™è¨˜çš„ä¿¡æ¯çª—å£
            infoWindow.open(map, marker);
          }
        });
      });
    }
    
    function importData() {
      const fileInput = document.getElementById('file-upload');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('è«‹é¸æ“‡æª”æ¡ˆ');
        return;
      }
      
      const fileName = file.name;
      const fileExtension = fileName.split('.').pop().toLowerCase();
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const content = e.target.result;
        
        switch (fileExtension) {
          case 'kml':
            importKML(content);
            break;
          case 'json':
          case 'geojson':
            importJSON(content);
            break;
          case 'csv':
            importCSV(content);
            break;
          default:
            alert('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼');
        }
      };
      
      if (fileExtension === 'kml') {
        reader.readAsText(file);
      } else if (fileExtension === 'json' || fileExtension === 'geojson') {
        reader.readAsText(file);
      } else if (fileExtension === 'csv') {
        reader.readAsText(file);
      }
    }
    
    function importKML(content) {
      // ä½¿ç”¨ Google Maps API çš„ KmlLayer åŠŸèƒ½
      try {
        // å…ˆå‰µå»ºä¸€å€‹è‡¨æ™‚ Blob ä¾†å‰µå»ºä¸€å€‹å¯ä¾› KmlLayer ä½¿ç”¨çš„ URL
        const blob = new Blob([content], { type: 'application/vnd.google-earth.kml+xml' });
        const blobUrl = URL.createObjectURL(blob);
        
        const kmlLayer = new google.maps.KmlLayer({
          url: blobUrl,
          map: map,
          preserveViewport: true
        });
        
        // æ·»åŠ åˆ°åœ–å±¤ç®¡ç†
        layers.push({
          name: 'åŒ¯å…¥çš„ KML åœ–å±¤',
          type: 'kml',
          layer: kmlLayer,
          visible: true
        });
        
        updateLayersUI();
        
        // ç›£è½ KML åœ–å±¤çš„ç‹€æ…‹
        google.maps.event.addListenerOnce(kmlLayer, 'status_changed', function() {
          if (kmlLayer.getStatus() !== 'OK') {
            alert('KML åŒ¯å…¥å¤±æ•—: ' + kmlLayer.getStatus());
          }
        });
      } catch (error) {
        console.error('KML åŒ¯å…¥éŒ¯èª¤:', error);
        alert('KML åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      }
    }
    
    function importJSON(content) {
      try {
        const data = JSON.parse(content);
        
        // è™•ç† GeoJSON æ ¼å¼
        if (data.type === 'FeatureCollection') {
          data.features.forEach(feature => {
            if (feature.geometry.type === 'Point') {
              const coords = feature.geometry.coordinates;
              const marker = new google.maps.Marker({
                position: { lat: coords[1], lng: coords[0] },
                map: map,
                title: feature.properties.name || 'åŒ¯å…¥é»'
              });
              
              markers.push(marker);
            } else if (feature.geometry.type === 'LineString') {
              const path = feature.geometry.coordinates.map(coord => {
                return { lat: coord[1], lng: coord[0] };
              });
              
              const polyline = new google.maps.Polyline({
                path: path,
                map: map,
                strokeColor: '#FF0000',
                strokeWeight: 2
              });
              
              polylines.push(polyline);
            } else if (feature.geometry.type === 'Polygon') {
              const paths = feature.geometry.coordinates[0].map(coord => {
                return { lat: coord[1], lng: coord[0] };
              });
              
              const polygon = new google.maps.Polygon({
                paths: paths,
                map: map,
                strokeColor: '#FF0000',
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.3
              });
              
              polygons.push(polygon);
            }
          });
        } else {
          // è™•ç†ç°¡å–®çš„ JSON é™£åˆ—
          data.forEach(item => {
            if (item.lat && item.lng) {
              const marker = new google.maps.Marker({
                position: { lat: parseFloat(item.lat), lng: parseFloat(item.lng) },
                map: map,
                title: item.name || 'åŒ¯å…¥é»'
              });
              
              markers.push(marker);
            }
          });
        }
        
        updateLayersUI();
        
      } catch (error) {
        console.error('JSON åŒ¯å…¥éŒ¯èª¤:', error);
        alert('JSON åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      }
    }
    
    function importCSV(content) {
      try {
        // ç°¡å–®çš„ CSV è§£æ
        const lines = content.split('\n');
        const headers = lines[0].split(',');
        
        // å°‹æ‰¾ç·¯åº¦å’Œç¶“åº¦çš„åˆ—
        let latIndex = -1;
        let lngIndex = -1;
        let nameIndex = -1;
        
        headers.forEach((header, index) => {
          const lowerHeader = header.toLowerCase().trim();
          if (lowerHeader === 'lat' || lowerHeader === 'latitude' || lowerHeader === 'ç·¯åº¦') {
            latIndex = index;
          } else if (lowerHeader === 'lng' || lowerHeader === 'longitude' || lowerHeader === 'long' || lowerHeader === 'ç¶“åº¦') {
            lngIndex = index;
          } else if (lowerHeader === 'name' || lowerHeader === 'title' || lowerHeader === 'åç¨±') {
            nameIndex = index;
          }
        });
        
        if (latIndex === -1 || lngIndex === -1) {
          alert('CSV æª”æ¡ˆä¸­æ‰¾ä¸åˆ°ç·¯åº¦æˆ–ç¶“åº¦åˆ—');
          return;
        }
        
        // å¾ç¬¬äºŒè¡Œé–‹å§‹è™•ç†æ•¸æ“š
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          
          const values = lines[i].split(',');
          const lat = parseFloat(values[latIndex]);
          const lng = parseFloat(values[lngIndex]);
          const name = nameIndex !== -1 ? values[nameIndex] : 'åŒ¯å…¥é»';
          
          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = new google.maps.Marker({
              position: { lat, lng },
              map: map,
              title: name
            });
            
            markers.push(marker);
          }
        }
        
        updateLayersUI();
        
      } catch (error) {
        console.error('CSV åŒ¯å…¥éŒ¯èª¤:', error);
        alert('CSV åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      }
    }
    
    function addNewLayer() {
      const layerName = prompt('è«‹è¼¸å…¥åœ–å±¤åç¨±:', 'æ–°åœ–å±¤');
      if (!layerName) return;
      
      // å‰µå»ºä¸€å€‹æ–°çš„åœ–å±¤å°è±¡
      const newLayer = {
        name: layerName,
        type: 'custom',
        markers: [],
        visible: true
      };
      
      layers.push(newLayer);
      updateLayersUI();
    }
    
    function updateLayersUI() {
      const container = document.getElementById('layers-container');
      container.innerHTML = '';
      
      // æ·»åŠ é è¨­åœ–å±¤
      container.innerHTML += `
        <div class="layer-item">
          <h3>
            æ™¯é»åœ–å±¤
            <span class="toggle-visibility" data-layer="attractions">ğŸ‘ï¸</span>
          </h3>
          <div class="layer-content">
            <small>åŒ…å« ${markers.filter(m => m.title && ['è˜‡é»ä¸–', 'æ—¥å…§ç“¦', 'ä¼¯æ©', 'ç‰æ£®', 'ç­–é¦¬ç‰¹'].includes(m.title)).length} å€‹åœ°é»</small>
          </div>
        </div>
      `;
      
      // æ·»åŠ è‡ªå®šç¾©åœ–å±¤
      layers.forEach((layer, index) => {
        container.innerHTML += `
          <div class="layer-item">
            <h3>
              ${layer.name}
              <span class="toggle-visibility" data-layer-index="${index}">ğŸ‘ï¸</span>
            </h3>
            <div class="layer-content">
              <small>åŒ…å« ${layer.type === 'kml' ? 'å¤šå€‹' : markers.length} å€‹åœ°é»</small>
            </div>
          </div>
        `;
      });
      
      // é‡æ–°ç¶å®šäº‹ä»¶
      document.querySelectorAll('.toggle-visibility').forEach(toggle => {
        toggle.addEventListener('click', toggleLayerVisibility);
      });
    }
    
    function toggleLayerVisibility(event) {
      const layerIndex = event.target.getAttribute('data-layer-index');
      
      if (layerIndex !== null) {
        const layer = layers[layerIndex];
        layer.visible = !layer.visible;
        
        if (layer.type === 'kml') {
          layer.layer.setMap(layer.visible ? map : null);
        } else {
          // è‡ªå®šç¾©åœ–å±¤çš„è™•ç†
          // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ‚¨éœ€è¦è¿½è¹¤æ¯å€‹åœ–å±¤ä¸­çš„æ¨™è¨˜
        }
        
        event.target.textContent = layer.visible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸';
      } else {
        // é è¨­åœ–å±¤çš„è™•ç†
        const layerName = event.target.getAttribute('
