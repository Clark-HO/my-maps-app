<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>瑞士行 - Travel Map</title>
  <style>
    /* 取消預設邊界與滾動，確保滿版且不會垂直捲動 */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    /* 使用 flex 排版，左側為圖層控制，右側為地圖 */
    #container {
      display: flex;
      height: 100%;
    }
    /* 左側欄位 */
    #sidebar {
      width: 250px;
      background-color: #f8f8f8;
      padding: 10px;
      box-sizing: border-box;
    }
    /* 右側地圖容器 */
    #map {
      flex: 1;
      position: relative;
    }
    /* 地圖上控制項：POI 滑桿 */
    #poi-control {
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px;
      font-size: 14px;
      margin: 10px;
    }
    /* 右上角繪圖工具 */
    #drawing-tools {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #fff;
      padding: 5px;
      border: 1px solid #ccc;
      z-index: 5;
    }
    /* 地圖標題 (置中) */
    #map-title {
      background: #fff;
      border: 1px solid #000;
      padding: 5px;
      margin: 10px;
      font-weight: bold;
    }
    /* 左側欄位其他控制項 */
    .control {
      margin-bottom: 10px;
    }
    #layer-list {
      list-style: none;
      padding-left: 5px;
      margin: 0;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- 左側欄位：圖層控制與匯入功能 -->
    <div id="sidebar">
      <h2>圖層控制</h2>
      <div class="control">
        <input type="file" id="file-input" multiple />
        <p>支援格式：KML、CSV、JSON</p>
      </div>
      <div class="control">
        <h3>圖層列表</h3>
        <ul id="layer-list">
          <!-- 動態新增圖層名稱 -->
        </ul>
      </div>
    </div>
    <!-- 右側：地圖 -->
    <div id="map"></div>
  </div>

  <!-- 地圖上加入 POI 調整滑桿 -->
  <div id="poi-control" style="position: absolute; top: 70px; left: 50%; transform: translateX(-50%); z-index:5;">
    <label for="poi-density">POI 顯示密度：</label>
    <input type="range" id="poi-density" min="0" max="100" value="50">
  </div>

  <!-- 右上角繪圖工具 -->
  <div id="drawing-tools">
    <button id="toggle-drawing">啟用繪圖</button>
    <button id="save-drawing">儲存圖層</button>
  </div>

  <!-- 地圖上方標題 -->
  <div id="map-title" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index:5;">
    瑞士行
  </div>

  <!-- 載入 Google Maps API，包含 drawing 與 places 函式庫，請將 YOUR_API_KEY 換成您的金鑰 -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=drawing,places"></script>
  <script>
    let map;
    let drawingManager;
    let currentDrawing = null;
    let poiMarkers = [];
    let currentLayerMarkers = [];
    let layers = [];

    function initMap() {
      // 設定瑞士中央座標
      const swissCenter = { lat: 46.8182, lng: 8.2275 };
      map = new google.maps.Map(document.getElementById('map'), {
        center: swissCenter,
        zoom: 8,
        mapTypeId: 'roadmap'
      });

      // 點擊地圖新增標記
      map.addListener('click', function(e) {
        addMarkerToCurrentLayer(e.latLng);
      });

      // 初始化繪圖工具
      initDrawingManager();

      // 初始化檔案匯入功能
      document.getElementById('file-input').addEventListener('change', handleFileSelect, false);

      // 初始化 POI 調整功能 (地圖上控制)
      document.getElementById('poi-density').addEventListener('input', function(e) {
        adjustPOIDensity(e.target.value);
      });
    }

    function initDrawingManager() {
      drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: false,
        markerOptions: { draggable: true },
        polylineOptions: { editable: true },
        polygonOptions: { editable: true },
        rectangleOptions: { editable: true },
        circleOptions: { editable: true }
      });
      drawingManager.setMap(map);

      // 繪製完成後處理
      google.maps.event.addListener(drawingManager, 'overlaycomplete', function(e) {
        currentDrawing = e.overlay;
        addLayer('自定義繪圖');
      });

      // 切換繪圖模式按鈕
      document.getElementById('toggle-drawing').addEventListener('click', function() {
        if (drawingManager.getDrawingMode()) {
          drawingManager.setDrawingMode(null);
          this.innerText = '啟用繪圖';
        } else {
          // 預設為標記模式，可依需求切換為其他繪圖類型
          drawingManager.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
          this.innerText = '停用繪圖';
        }
      });

      // 儲存繪圖按鈕
      document.getElementById('save-drawing').addEventListener('click', function() {
        if (currentDrawing) {
          const data = getOverlayData(currentDrawing);
          saveDataToCloud(data);
        } else {
          alert('目前沒有繪製的圖形');
        }
      });
    }

    // 將 overlay 轉成可存資料格式（點、線、面）
    function getOverlayData(overlay) {
      if (overlay.getPath) { // 多邊形或折線
        const path = overlay.getPath().getArray().map(latlng => ({ lat: latlng.lat(), lng: latlng.lng() }));
        return { type: 'poly', path: path };
      } else if (overlay.getPosition) { // 標記
        const pos = overlay.getPosition();
        return { type: 'marker', position: { lat: pos.lat(), lng: pos.lng() } };
      }
      return {};
    }

    // 模擬儲存資料至 Google Cloud datasets（請自行串接後端 API）
    function saveDataToCloud(data) {
      console.log('Saving to Google Cloud:', data);
      fetch('/saveData', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        console.log('Data saved:', result);
      })
      .catch(err => {
        console.error('Error saving data:', err);
      });
    }

    // 點擊地圖新增標記，並將標記加入目前圖層
    function addMarkerToCurrentLayer(location) {
      const marker = new google.maps.Marker({
        position: location,
        map: map,
        draggable: true
      });
      currentLayerMarkers.push(marker);
      addLayer('新增點');
      // 同時模擬存入雲端
      saveDataToCloud({ type: 'marker', position: { lat: location.lat(), lng: location.lng() } });
    }

    // 處理檔案匯入：依副檔名處理 KML、JSON、CSV
    function handleFileSelect(evt) {
      const files = evt.target.files;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        reader.onload = function(e) {
          const content = e.target.result;
          if (file.name.toLowerCase().endsWith('.kml')) {
            // 利用 KmlLayer 匯入 KML 檔案
            const kmlLayer = new google.maps.KmlLayer({
              url: URL.createObjectURL(new Blob([content], {type: 'application/vnd.google-earth.kml+xml'})),
              map: map
            });
            layers.push(kmlLayer);
            addLayer(file.name);
          } else if (file.name.toLowerCase().endsWith('.json')) {
            // 假設 JSON 為點資料陣列：每個物件含 lat, lng, name
            const jsonData = JSON.parse(content);
            jsonData.forEach(item => {
              const marker = new google.maps.Marker({
                position: { lat: item.lat, lng: item.lng },
                map: map,
                title: item.name || ''
              });
              currentLayerMarkers.push(marker);
            });
            addLayer(file.name);
          } else if (file.name.toLowerCase().endsWith('.csv')) {
            // 簡易 CSV 解析，格式：lat,lng,name
            const lines = content.split('\n');
            lines.forEach(line => {
              const parts = line.split(',');
              if (parts.length >= 2) {
                const lat = parseFloat(parts[0]);
                const lng = parseFloat(parts[1]);
                const title = parts[2] || '';
                if (!isNaN(lat) && !isNaN(lng)) {
                  const marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    title: title
                  });
                  currentLayerMarkers.push(marker);
                }
              }
            });
            addLayer(file.name);
          }
          // 匯入後模擬存入雲端
          saveDataToCloud({ importedFile: file.name, content: content });
        };
        reader.readAsText(file);
      }
    }

    // 將新增的圖層名稱加入左側列表中
    function addLayer(name) {
      const li = document.createElement('li');
      li.textContent = name;
      document.getElementById('layer-list').appendChild(li);
    }

    // 調整 POI 顯示密度：依據 slider 數值模擬在瑞士附近隨機產生標記
    function adjustPOIDensity(value) {
      // 清除舊的 POI 標記
      poiMarkers.forEach(marker => marker.setMap(null));
      poiMarkers = [];
      const numMarkers = Math.floor(value);
      for (let i = 0; i < numMarkers; i++) {
        const marker = new google.maps.Marker({
          position: {
            lat: 46.8182 + (Math.random() - 0.5),
            lng: 8.2275 + (Math.random() - 0.5)
          },
          map: map,
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
          }
        });
        poiMarkers.push(marker);
      }
    }

    // 初始化地圖
    window.onload = initMap;
  </script>
</body>
</html>
