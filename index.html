<!DOCTYPE html>
<html>

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JSFiddle r26pywad</title>

  <style>
    html,
body {
  height: 100%;
  margin: 0 ;
  padding: 0;
}

.place-picker-container {
  padding: 10px;
}
  </style>

  
</head>
<body>
  <!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps 應用</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }
        
        #map-container {
            flex: 2;
            height: 100%;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        #sidebar {
            flex: 1;
            padding: 20px;
            background-color: #f4f4f4;
            overflow-y: auto;
            max-width: 300px;
        }
        
        .location-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .location-card h3 {
            margin-top: 0;
            color: #333;
        }
        
        .control-panel {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        input, button {
            padding: 8px;
            margin: 5px 0;
        }
        
        button {
            background-color: #4285F4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #3367D6;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
    </div>
    
    <div id="sidebar">
        <div class="control-panel">
            <h2>新增地點</h2>
            <input type="text" id="location-name" placeholder="地點名稱">
            <input type="text" id="location-description" placeholder="地點描述">
            <button id="add-current-location">新增當前位置</button>
            <button id="find-nearby">搜尋附近地點</button>
            <input type="number" id="radius" placeholder="搜尋半徑 (米)" value="500">
        </div>
        
        <h2>附近地點</h2>
        <div id="nearby-places"></div>
    </div>

    <script>
        // 存儲地圖、標記和位置資訊
        let map;
        let userMarker;
        let userPosition;
        let markers = [];
        let customLocations = [];
        let placesService;
        
        // 初始化地圖
        function initMap() {
            // 預設位置（如果沒有獲取到用戶位置）
            const defaultLocation = { lat: 25.033, lng: 121.565 }; // 台北市
            
            // 創建地圖
            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultLocation,
                zoom: 15,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true,
            });
            
            // 創建地點服務
            placesService = new google.maps.places.PlacesService(map);
            
            // 獲取用戶當前位置
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        
                        // 移動地圖到用戶位置
                        map.setCenter(userPosition);
                        
                        // 在地圖上標記用戶位置
                        userMarker = new google.maps.Marker({
                            position: userPosition,
                            map: map,
                            title: "您的位置",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: "#4285F4",
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: "#FFFFFF",
                            },
                        });
                    },
                    () => {
                        // 如果用戶拒絕位置權限，使用預設位置
                        alert("無法獲取您的位置，使用預設位置。");
                        userPosition = defaultLocation;
                        map.setCenter(userPosition);
                    }
                );
            } else {
                // 瀏覽器不支持地理位置
                alert("您的瀏覽器不支持地理位置功能。");
                userPosition = defaultLocation;
                map.setCenter(userPosition);
            }
            
            // 點擊地圖添加新標記
            map.addListener("click", (event) => {
                placeMarkerOnClick(event.latLng);
            });
            
            // 按鈕事件監聽
            document.getElementById("add-current-location").addEventListener("click", addCurrentLocation);
            document.getElementById("find-nearby").addEventListener("click", findNearbyPlaces);
        }
        
        // 在地圖上點擊位置放置標記
        function placeMarkerOnClick(location) {
            const locationName = document.getElementById("location-name").value || "新地點";
            const locationDescription = document.getElementById("location-description").value || "無描述";
            
            addMarker(location, locationName, locationDescription);
        }
        
        // 添加標記到地圖
        function addMarker(location, title, description) {
            const marker = new google.maps.Marker({
                position: location,
                map: map,
                title: title,
                animation: google.maps.Animation.DROP,
            });
            
            markers.push(marker);
            
            // 存儲自定義地點資訊
            const newLocation = {
                id: Date.now().toString(),
                name: title,
                description: description,
                position: location,
                marker: marker,
            };
            
            customLocations.push(newLocation);
            
            // 為標記添加點擊事件
            const infoWindow = new google.maps.InfoWindow({
                content: `<div><h3>${title}</h3><p>${description}</p></div>`,
            });
            
            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });
            
            // 更新側邊欄
            updateSidebar();
        }
        
        // 添加當前位置作為新地點
        function addCurrentLocation() {
            if (!userPosition) {
                alert("無法獲取您的位置。");
                return;
            }
            
            const locationName = document.getElementById("location-name").value || "我的位置";
            const locationDescription = document.getElementById("location-description").value || "這是我的位置";
            
            addMarker(userPosition, locationName, locationDescription);
        }
        
        // 搜尋附近地點
        function findNearbyPlaces() {
            if (!userPosition) {
                alert("無法獲取您的位置。");
                return;
            }
            
            const radius = parseInt(document.getElementById("radius").value) || 500;
            
            // 清除先前的搜尋結果
            markers.forEach((marker) => {
                if (marker !== userMarker) {
                    marker.setMap(null);
                }
            });
            
            markers = userMarker ? [userMarker] : [];
            
            // 搜尋附近的地點
            const request = {
                location: userPosition,
                radius: radius,
                type: ["point_of_interest"]
            };
            
            placesService.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    // 處理搜尋結果
                    results.forEach((place) => {
                        if (place.geometry && place.geometry.location) {
                            const marker = new google.maps.Marker({
                                map: map,
                                position: place.geometry.location,
                                title: place.name,
                                icon: {
                                    url: place.icon,
                                    scaledSize: new google.maps.Size(24, 24)
                                }
                            });
                            
                            markers.push(marker);
                            
                            // 為標記添加點擊事件，顯示詳細資訊
                            marker.addListener("click", () => {
                                getPlaceDetails(place.place_id, marker);
                            });
                        }
                    });
                    
                    // 更新附近地點列表
                    updateNearbyPlacesList(results);
                }
            });
        }
        
        // 獲取地點詳細資訊
        function getPlaceDetails(placeId, marker) {
            const request = {
                placeId: placeId,
                fields: ["name", "formatted_address", "rating", "formatted_phone_number", "website", "opening_hours", "photos", "types", "reviews"]
            };
            
            placesService.getDetails(request, (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    // 創建資訊視窗內容
                    let content = `<div style="max-width:300px">`;
                    content += `<h3>${place.name}</h3>`;
                    
                    if (place.photos && place.photos.length > 0) {
                        content += `<img src="${place.photos[0].getUrl({maxWidth: 200, maxHeight: 150})}" style="width:100%;max-width:200px">`;
                    }
                    
                    if (place.formatted_address) {
                        content += `<p><strong>地址:</strong> ${place.formatted_address}</p>`;
                    }
                    
                    if (place.formatted_phone_number) {
                        content += `<p><strong>電話:</strong> ${place.formatted_phone_number}</p>`;
                    }
                    
                    if (place.rating) {
                        content += `<p><strong>評分:</strong> ${place.rating} / 5</p>`;
                    }
                    
                    if (place.opening_hours) {
                        content += `<p><strong>營業狀態:</strong> ${place.opening_hours.isOpen() ? "營業中" : "休息中"}</p>`;
                    }
                    
                    if (place.website) {
                        content += `<p><a href="${place.website}" target="_blank">訪問網站</a></p>`;
                    }
                    
                    content += `</div>`;
                    
                    // 打開資訊視窗
                    const infoWindow = new google.maps.InfoWindow({
                        content: content
                    });
                    
                    infoWindow.open(map, marker);
                }
            });
        }
        
        // 更新附近地點列表
        function updateNearbyPlacesList(places) {
            const container = document.getElementById("nearby-places");
            container.innerHTML = "";
            
            if (places.length === 0) {
                container.innerHTML = "<p>沒有找到附近地點。</p>";
                return;
            }
            
            places.forEach((place) => {
                const card = document.createElement("div");
                card.className = "location-card";
                
                let cardContent = `<h3>${place.name}</h3>`;
                
                if (place.vicinity) {
                    cardContent += `<p><strong>地址:</strong> ${place.vicinity}</p>`;
                }
                
                if (place.rating) {
                    cardContent += `<p><strong>評分:</strong> ${place.rating} / 5</p>`;
                }
                
                cardContent += `<button class="view-details" data-place-id="${place.place_id}">查看詳情</button>`;
                
                card.innerHTML = cardContent;
                container.appendChild(card);
                
                // 添加查看詳情按鈕事件
                card.querySelector(".view-details").addEventListener("click", () => {
                    // 找到對應的標記
                    const marker = markers.find(m => m.getPosition().equals(place.geometry.location));
                    if (marker) {
                        // 將地圖中心移動到該地點
                        map.setCenter(marker.getPosition());
                        // 獲取並顯示詳細資訊
                        getPlaceDetails(place.place_id, marker);
                    }
                });
            });
        }
        
        // 更新自定義地點側邊欄
        function updateSidebar() {
            const container = document.getElementById("nearby-places");
            container.innerHTML = "";
            
            if (customLocations.length === 0) {
                container.innerHTML = "<p>尚未添加任何地點。</p>";
                return;
            }
            
            customLocations.forEach((location) => {
                const card = document.createElement("div");
                card.className = "location-card";
                
                let cardContent = `<h3>${location.name}</h3>`;
                cardContent += `<p>${location.description}</p>`;
                cardContent += `<button class="show-on-map" data-id="${location.id}">在地圖上顯示</button>`;
                
                card.innerHTML = cardContent;
                container.appendChild(card);
                
                // 添加在地圖上顯示按鈕事件
                card.querySelector(".show-on-map").addEventListener("click", () => {
                    map.setCenter(location.position);
                    google.maps.event.trigger(location.marker, "click");
                });
            });
        }
    </script>
    
    <!-- 引入 Google Maps JavaScript API -->
    <script 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDdn8mykqlHT8WPT_tnrZmj5OS4JYw0UPM&libraries=places&callback=initMap" 
        async defer>
    </script>
</body>
</html>

  <script>
    async function init() {
  await customElements.whenDefined('gmp-map');

  const map = document.querySelector('gmp-map');
  const marker = document.querySelector('gmp-advanced-marker');
  const placePicker = document.querySelector('gmpx-place-picker');
  const infowindow = new google.maps.InfoWindow();

  map.innerMap.setOptions({
    mapTypeControl: false
  });

  placePicker.addEventListener('gmpx-placechange', () => {
    const place = placePicker.value;

    if (!place.location) {
      window.alert(
        "No details available for input: '" + place.name + "'"
      );
      infowindow.close();
      marker.position = null;
      return;
    }

    if (place.viewport) {
      map.innerMap.fitBounds(place.viewport);
    } else {
      map.center = place.location;
      map.zoom = 17;
    }

    marker.position = place.location;
    infowindow.setContent(
      `<strong>${place.displayName}</strong><br>
       <span>${place.formattedAddress}</span>
    `);
    infowindow.open(map.innerMap, marker);
  });
}

document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
